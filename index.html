<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kodin Infonäyttö</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #1a202c;
      color: #e2e8f0;
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0';

    const App = () => {
      const [time, setTime] = useState(new Date());
      const [weather, setWeather] = useState(null);
      const [events, setEvents] = useState([]);
      const [loading, setLoading] = useState(true);

      const weatherConfig = {
        apiKey: '156f04a68c2cc658949448716a6efec9',
        city: 'Pattijoki',
        unit: 'metric',
      };

      const calendarUrls = [
        { name: 'Nanni', url: 'https://calendar.google.com/calendar/ical/nannijarvela9%40gmail.com/public/basic.ics' },
        { name: 'Isi', url: 'https://outlook.live.com/owa/calendar/64d6b909-6b21-4416-9df0-86d8cf34c0eb/990d6ea5-a2e6-49f7-816d-a55768fcbc8b/cid-1A1686A8D4FF8E43/calendar.ics' },
        { name: 'Onerva', url: 'YOUR_CHILD2_SCHEDULE_ICAL_URL' },
        { name: 'Elmeri', url: 'YOUR_CHILD3_SCHEDULE_ICAL_URL' },
      ];

      const fetchWeather = async () => {
        if (weatherConfig.apiKey === 'YOUR_OPENWEATHERMAP_API_KEY') {
          console.error('Weather API key not set.');
          return;
        }

        try {
          const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?q=${weatherConfig.city}&units=${weatherConfig.unit}&appid=${weatherConfig.apiKey}`
          );
          if (!response.ok) throw new Error('Failed to fetch weather');
          const data = await response.json();
          setWeather({
            temp: Math.round(data.main.temp),
            description: data.weather[0].description,
            icon: data.weather[0].icon,
          });
        } catch (error) {
          console.error('Error fetching weather:', error);
        }
      };

      const fetchIcal = async (url) => {
        if (!url || url.startsWith('YOUR_')) {
          return [];
        }

        try {
          const response = await fetch(url);
          if (!response.ok) {
            console.error(`Error fetching iCal data from ${url}: ${response.statusText}`);
            return [];
          }
          const text = await response.text();
          const lines = text.split('\n');
          const calendarEvents = [];
          let currentEvent = null;
          for (const line of lines) {
            if (line.startsWith('BEGIN:VEVENT')) {
              currentEvent = {};
            } else if (line.startsWith('END:VEVENT')) {
              if (currentEvent.summary && currentEvent.dtstart) {
                calendarEvents.push(currentEvent);
              }
              currentEvent = null;
            } else if (currentEvent) {
              const [key, value] = line.split(':');
              if (key === 'SUMMARY') currentEvent.summary = value;
              if (key === 'DTSTART') currentEvent.dtstart = value;
              if (key === 'DTEND') currentEvent.dtend = value;
            }
          }
          return calendarEvents;
        } catch (error) {
          console.error(`Error fetching or parsing iCal from ${url}:`, error);
          return [];
        }
      };
      
      const fetchAllCalendars = async () => {
        let allEvents = [];
        for (const calendar of calendarUrls) {
          if (!calendar.url || calendar.url.startsWith('YOUR_')) {
            console.warn(`Calendar URL for "${calendar.name}" is not set.`);
            continue;
          }
          const newEvents = await fetchIcal(calendar.url);
          allEvents = [...allEvents, ...newEvents.map(e => ({ ...e, source: calendar.name }))];
        }
        allEvents.sort((a, b) => {
          const dateA = a.dtstart ? new Date(a.dtstart) : new Date(0);
          const dateB = b.dtstart ? new Date(b.dtstart) : new Date(0);
          return dateA - dateB;
        });
        setEvents(allEvents);
      };

      useEffect(() => {
        fetchWeather();
        fetchAllCalendars();
        setLoading(false);

        const weatherInterval = setInterval(fetchWeather, 3600000);
        const calendarInterval = setInterval(fetchAllCalendars, 900000);
        const timeInterval = setInterval(() => setTime(new Date()), 1000);

        return () => {
          clearInterval(weatherInterval);
          clearInterval(calendarInterval);
          clearInterval(timeInterval);
        };
      }, []);

      const formatDateTime = (date) => {
        const options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        };
        return date.toLocaleDateString('fi-FI', options) + ', ' + date.toLocaleTimeString('fi-FI', { hour: '2-digit', minute: '2-digit' });
      };

      const formatEventDate = (icalDate) => {
        if (!icalDate) return '';
        const year = icalDate.substring(0, 4);
        const month = icalDate.substring(4, 6);
        const day = icalDate.substring(6, 8);
        const hour = icalDate.substring(9, 11);
        const minute = icalDate.substring(11, 13);
        return `${day}.${month}.${year} klo ${hour}:${minute}`;
      };

      const getDailyEvents = (personName) => {
        const today = new Date().toISOString().substring(0, 10);
        return events.filter(event => 
          event.source === personName &&
          event.dtstart && event.dtstart.startsWith(today.replace(/-/g, ''))
        );
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen">
            <p>Ladataan...</p>
          </div>
        );
      }

      return (
        <div className="flex flex-col min-h-screen p-6">
          <header className="flex justify-between items-center mb-8">
            <h1 className="text-3xl md:text-4xl font-bold">Kodin Infonäyttö</h1>
            <p className="text-xl md:text-2xl text-right">
              {formatDateTime(time)}
            </p>
          </header>

          <main className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-grow">
            <div className="bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col justify-between">
              <h2 className="text-2xl font-semibold mb-4">Sää</h2>
              {weather && (
                <div className="flex items-center space-x-4">
                  <img
                    src={`https://openweathermap.org/img/wn/${weather.icon}@2x.png`}
                    alt={weather.description}
                    className="w-20 h-20"
                  />
                  <div>
                    <p className="text-5xl font-bold">{weather.temp}°C</p>
                    <p className="text-lg capitalize">{weather.description}</p>
                    <p className="text-md">Sijainti: {weatherConfig.city}</p>
                  </div>
                </div>
              )}
              {!weather && <p>Säätietoja ei ole saatavilla.</p>}
            </div>

            <div className="bg-gray-800 rounded-xl shadow-lg p-6 col-span-1 md:col-span-2">
              <h2 className="text-2xl font-semibold mb-4">Päivän tapahtumat</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {calendarUrls.map((person, index) => (
                  <div key={index} className="bg-gray-700 rounded-xl p-4">
                    <h3 className="font-bold text-xl mb-2">{person.name}</h3>
                    {getDailyEvents(person.name).length > 0 ? (
                      <div className="space-y-2">
                        {getDailyEvents(person.name).map((event, eventIndex) => (
                          <div key={eventIndex} className="bg-gray-600 rounded-lg p-3">
                            <p className="font-semibold">{event.summary}</p>
                            <p className="text-sm text-gray-400">{formatEventDate(event.dtstart)}</p>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-400">Ei tapahtumia tänään.</p>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </main>
        </div>
      );
    };
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
